<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />



<meta name="date" content="2017-12-16" />

<title>Diagnostics</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/paper.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/textmate.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>
<script src="site_libs/htmlwidgets-0.9/htmlwidgets.js"></script>
<script src="site_libs/viz-0.3/viz.js"></script>
<link href="site_libs/DiagrammeR-styles-0.2/styles.css" rel="stylesheet" />
<script src="site_libs/grViz-binding-0.9.2/grViz.js"></script>

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>

<link rel="stylesheet" href="styles.css" type="text/css" />

</head>

<body>

<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
  height: auto;
}
.tabbed-pane {
  padding-top: 12px;
}
button.code-folding-btn:focus {
  outline: none;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 64px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 69px;
  margin-top: -69px;
}

.section h2 {
  padding-top: 69px;
  margin-top: -69px;
}
.section h3 {
  padding-top: 69px;
  margin-top: -69px;
}
.section h4 {
  padding-top: 69px;
  margin-top: -69px;
}
.section h5 {
  padding-top: 69px;
  margin-top: -69px;
}
.section h6 {
  padding-top: 69px;
  margin-top: -69px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>


<div class="container-fluid main-container">

<!-- tabsets -->
<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});
</script>

<!-- code folding -->




<script>
$(document).ready(function ()  {

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_').toLowerCase();
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = false;
    options.smoothScroll = false;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}


.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
  padding-left: 25px;
  text-indent: 0;
}

.tocify .list-group-item {
  border-radius: 0px;
}

.tocify-subheader {
  display: inline;
}
.tocify-subheader .tocify-item {
  font-size: 0.95em;
}

</style>

<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row-fluid">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Working With Stan</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">Summary</a>
</li>
<li>
  <a href="one_source.html">One Process</a>
</li>
<li>
  <a href="common_source.html">Common Process</a>
</li>
<li>
  <a href="two_sources.html">Two Processes</a>
</li>
<li>
  <a href="diag_details.html">Diagnostics</a>
</li>
<li>
  <a href="references.html">References</a>
</li>
<li>
  <a href="about.html">About</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">



<h1 class="title toc-ignore">Diagnostics</h1>
<h4 class="date"><em>12/16/2017</em></h4>

</div>


<div id="the-data-one-process" class="section level2">
<h2>The Data: One Process</h2>
<p>Independent observations with two possible outcomes on a trial.</p>
<pre><code>## In file included from file17ef7d0cfd02.cpp:8:
## In file included from /Library/Frameworks/R.framework/Versions/3.3/Resources/library/StanHeaders/include/src/stan/model/model_header.hpp:4:
## In file included from /Library/Frameworks/R.framework/Versions/3.3/Resources/library/StanHeaders/include/stan/math.hpp:4:
## In file included from /Library/Frameworks/R.framework/Versions/3.3/Resources/library/StanHeaders/include/stan/math/rev/mat.hpp:4:
## In file included from /Library/Frameworks/R.framework/Versions/3.3/Resources/library/StanHeaders/include/stan/math/rev/core.hpp:12:
## In file included from /Library/Frameworks/R.framework/Versions/3.3/Resources/library/StanHeaders/include/stan/math/rev/core/gevv_vvv_vari.hpp:5:
## In file included from /Library/Frameworks/R.framework/Versions/3.3/Resources/library/StanHeaders/include/stan/math/rev/core/var.hpp:7:
## In file included from /Library/Frameworks/R.framework/Versions/3.3/Resources/library/BH/include/boost/math/tools/config.hpp:13:
## In file included from /Library/Frameworks/R.framework/Versions/3.3/Resources/library/BH/include/boost/config.hpp:39:
## /Library/Frameworks/R.framework/Versions/3.3/Resources/library/BH/include/boost/config/compiler/clang.hpp:200:11: warning: &#39;BOOST_NO_CXX11_RVALUE_REFERENCES&#39; macro redefined [-Wmacro-redefined]
## #  define BOOST_NO_CXX11_RVALUE_REFERENCES
##           ^
## &lt;command line&gt;:6:9: note: previous definition is here
## #define BOOST_NO_CXX11_RVALUE_REFERENCES 1
##         ^
## 1 warning generated.
## 
## Gradient evaluation took 1.1e-05 seconds
## 1000 transitions using 10 leapfrog steps per transition would take 0.11 seconds.
## Adjust your expectations accordingly!
## 
## 
## 
##  Elapsed Time: 0.014303 seconds (Warm-up)
##                0.012346 seconds (Sampling)
##                0.026649 seconds (Total)
## 
## 
## Gradient evaluation took 4e-06 seconds
## 1000 transitions using 10 leapfrog steps per transition would take 0.04 seconds.
## Adjust your expectations accordingly!
## 
## 
## 
##  Elapsed Time: 0.010302 seconds (Warm-up)
##                0.013932 seconds (Sampling)
##                0.024234 seconds (Total)
## 
## 
## Gradient evaluation took 3e-06 seconds
## 1000 transitions using 10 leapfrog steps per transition would take 0.03 seconds.
## Adjust your expectations accordingly!
## 
## 
## 
##  Elapsed Time: 0.011496 seconds (Warm-up)
##                0.013336 seconds (Sampling)
##                0.024832 seconds (Total)
## 
## 
## Gradient evaluation took 5e-06 seconds
## 1000 transitions using 10 leapfrog steps per transition would take 0.05 seconds.
## Adjust your expectations accordingly!
## 
## 
## 
##  Elapsed Time: 0.010709 seconds (Warm-up)
##                0.011854 seconds (Sampling)
##                0.022563 seconds (Total)</code></pre>
<p>Use ggplot to generate a data graph showing successes, failures, and total observations. <img src="diag_details_files/figure-html/visualize_data-1.png" width="480" /></p>
</div>
<div id="the-model" class="section level2">
<h2>The Model</h2>
<p>A graphical representation of the model shows:</p>
<ul>
<li>a continuous, unobserved “process” parameter <span class="math inline">\(\theta\)</span></li>
<li>a discrete, observable number of successes <em>k</em></li>
<li>a discrete, observable number of observations <em>n</em></li>
</ul>
<p>The vector’s arrow shows dependency. Successes are dependent on both the underlying process <span class="math inline">\(\theta\)</span> and the number of observations.</p>
<p>The assumption for <span class="math inline">\(\theta\)</span> is that all possible rates are equally likely. The Beta distribution is set with 1 “success” and 1 “failure”.</p>
<p>The assumption of <em>k</em> is that the outcomes are from a Binomial distribution with <span class="math inline">\(\theta\)</span> determining the rate for <em>n</em> observations.</p>
<p><div id="htmlwidget-42a2990c439a8723d414" style="width:200px;height:200px;" class="grViz html-widget"></div>
<script type="application/json" data-for="htmlwidget-42a2990c439a8723d414">{"x":{"diagram":"\n    digraph boxes_and_circles {\n    \n    # graph statement\n    graph [overlap=false, fontsize=10]\n    \n    # node statements\n    node [shape=circle,\n    color=black,\n    style=filled,\n    fillcolor=white,\n    peripheries=1]\n    t [ label=<&theta;>]\n    \n    node [shape=square,\n    color=black,\n    style=filled,\n    fillcolor=grey,\n    peripheries=1]\n    k [label=<<I>k<\/I>>]\n    n [label=<<I>n<\/I>>]\n    \n    node [shape=plain,\n    color=black,\n    style=filled,\n    fillcolor=white,\n    peripheries=0]\n    note_1 [label=<&theta; ~ Beta(1,1)>]\n    note_2 [label=<<I>k <\/I> ~ Binomial(&theta;,<I>n<\/I>)>]\n    \n    subgraph {\n    rank = same; t; note_1;\n    }\n    \n    subgraph {\n    rank = same; k; note_2;\n    }\n    \n    # edge statements\n    edge [arrowhead=vee,arrowtail=vee]\n    t->k\n    k->n [dir=back]\n    }\n    ","config":{"engine":"dot","options":null}},"evals":[],"jsHooks":[]}</script> ### Basic Stan Output</p>
<p>Info from a S4 object of class <a href="https://cran.r-project.org/web/packages/rstan/vignettes/stanfit-objects.html">stanfit</a></p>
<p>Use get_stancode to extract the model from the stan output</p>
<pre><code>## // Infering a Rate &quot;theta&quot; of a binary process
## // Section 3.1 
## // Figure 3.2
## data {
##   int&lt;lower=1&gt; n; // at least one observation
##   int&lt;lower=0&gt; k; // success count can not be negative
## }
## 
## parameters {
##   real&lt;lower=0, upper=1&gt; theta; // rate bounded by 0 and 1
## }
## 
## model {
##   //Prior Distribution for Rate Theta
##   theta ~ beta(1, 1);
##   
##   // Observed Counts
##   // k has a binomial distribution of n observations with theta variation
##   k ~ binomial(n, theta);
## }</code></pre>
<p>Print on a stanfit object shows summary of parameter and log-posterior (lp__) posterior mean, posterior standard deviation, and quantiles:</p>
<ul>
<li>first parameter is “theta”</li>
<li>second parameter is “lp__&quot; - the log posterior density</li>
<li>se_mean is the Monte Carlo standard error</li>
<li>n_eff is the effective sample size</li>
<li>Rhat is the R-hat statistic</li>
</ul>
<p>Convergence of log posterior density is critical to declaring convergence (see stan-reference-2.16.0.pdf pg 368-369).</p>
<pre><code>## Inference for Stan model: binomial_one_rate.
## 4 chains, each with iter=2000; warmup=1000; thin=1; 
## post-warmup draws per chain=1000, total post-warmup draws=4000.
## 
##        mean se_mean   sd   2.5%   25%   50%   75% 97.5% n_eff Rhat
## theta  0.58    0.00 0.14   0.30  0.48  0.58  0.68  0.83  1648    1
## lp__  -8.67    0.02 0.74 -10.81 -8.82 -8.39 -8.20 -8.15  1725    1
## 
## Samples were drawn using NUTS(diag_e) at Sat Dec 16 12:27:32 2017.
## For each parameter, n_eff is a crude measure of effective sample size,
## and Rhat is the potential scale reduction factor on split chains (at 
## convergence, Rhat=1).</code></pre>
<div id="diagnostics" class="section level3">
<h3>Diagnostics</h3>
<div id="rhat---potential-scale-reduction-statistic" class="section level4">
<h4>Rhat - potential scale reduction statistic</h4>
<p>If chains are at equilibrium, rhat will be 1. If the chains have not converged rhat will be greater than one.</p>
<p><img src="diag_details_files/figure-html/unnamed-chunk-3-1.png" width="480" /></p>
</div>
<div id="neff_ratio---look-at-effective-sample-size" class="section level4">
<h4>neff_ratio - Look at effective sample size</h4>
<p>Draws in a Markov chain are not independent if there is autocorrelation. If there is autocorrelation, the effective sample size will be smaller than the total sample size, N.</p>
<p>The larger the ratio of neff to N the better.</p>
<pre><code>##     theta      lp__ 
## 0.4120353 0.4313311</code></pre>
<p><img src="diag_details_files/figure-html/unnamed-chunk-4-1.png" width="480" /></p>
</div>
<div id="mcmc_acf---autocorrelation---centered-parameterization-cp" class="section level4">
<h4>mcmc_acf - Autocorrelation - centered parameterization (CP)</h4>
<p>View autocorrelation for each Markov chain separately up to a specified number of lags.</p>
<p>Lag - the distance between successive samples.</p>
<p>The autocorrelation function (ACF) relates correlation and lag. The values of the ACF should quickly decrease with increasing lag. ACFs that do not decrease quickly with lag often indicate that the sampler is not exploring the posterior distribution efficiently and result in increased R^ values and decreased Neff values. (See <a href="https://my.vanderbilt.edu/jeffannis/files/2016/06/AnnisMillerPalmeri2016.pdf">Bayesian inference with Stan: A tutorial on adding custom distributions</a> <img src="diag_details_files/figure-html/unnamed-chunk-5-1.png" width="480" /></p>
</div>
<div id="evaluate-nuts-sampler" class="section level4">
<h4>Evaluate NUTS sampler</h4>
<p>Extract the log posterior over iterations. Extract iterations with divergence.</p>
<p>Trace plot of MCMC draws and divergence, if any, for NUTS.</p>
<pre><code>##   Iteration     Value Chain
## 1         1 -8.360693     1
## 2         2 -8.196771     1
## 3         3 -9.723596     1
## 4         4 -8.314626     1
## 5         5 -9.895314     1
## 6         6 -9.122828     1</code></pre>
<pre><code>##   Iteration     Parameter     Value Chain
## 1         1 accept_stat__ 0.9447556     1
## 2         2 accept_stat__ 1.0000000     1
## 3         3 accept_stat__ 0.6408017     1
## 4         4 accept_stat__ 1.0000000     1
## 5         5 accept_stat__ 0.3673829     1
## 6         6 accept_stat__ 1.0000000     1</code></pre>
<pre><code>## No divergences to plot.</code></pre>
<p><img src="diag_details_files/figure-html/unnamed-chunk-6-1.png" width="480" /></p>
<div id="a-different-look-at-divergence." class="section level5">
<h5>A different look at divergence.</h5>
<p>Divergences often indicate that some part of the posterior isn’t being explored. Divergence shows as distortions in the smooth funnel.</p>
<p><img src="diag_details_files/figure-html/unnamed-chunk-7-1.png" width="480" /></p>
</div>
</div>
<div id="other-diagnostics-graphs" class="section level4">
<h4>Other Diagnostics &amp; Graphs</h4>
<p>A more detailed summary.</p>
<pre><code>## $summary
##             mean     se_mean        sd        2.5%        25%        50%
## theta  0.5773151 0.003378536 0.1371595   0.2993314  0.4832189  0.5783767
## lp__  -8.6726841 0.017885551 0.7429125 -10.8128021 -8.8245552 -8.3932704
##              75%      97.5%    n_eff     Rhat
## theta  0.6793896  0.8303485 1648.141 1.000708
## lp__  -8.2023916 -8.1510614 1725.324 1.000807
## 
## $c_summary
## , , chains = chain:1
## 
##          stats
## parameter       mean        sd        2.5%       25%        50%        75%
##     theta  0.5663588 0.1419428   0.2922506  0.467130  0.5690747  0.6719294
##     lp__  -8.7118830 0.7852922 -10.8394255 -8.872874 -8.4046407 -8.2132009
##          stats
## parameter      97.5%
##     theta  0.8330117
##     lp__  -8.1513747
## 
## , , chains = chain:2
## 
##          stats
## parameter       mean        sd        2.5%        25%        50%
##     theta  0.5839208 0.1364415   0.2956341  0.4962677  0.5870431
##     lp__  -8.6732204 0.7852458 -11.1709338 -8.7904591 -8.3884646
##          stats
## parameter        75%      97.5%
##     theta  0.6859116  0.8329932
##     lp__  -8.1950169 -8.1507644
## 
## , , chains = chain:3
## 
##          stats
## parameter       mean        sd        2.5%        25%        50%       75%
##     theta  0.5772236 0.1334808   0.3125112  0.4822294  0.5804903  0.674813
##     lp__  -8.6407682 0.6920058 -10.5854223 -8.7917958 -8.3807140 -8.199014
##          stats
## parameter      97.5%
##     theta  0.8246271
##     lp__  -8.1510024
## 
## , , chains = chain:4
## 
##          stats
## parameter       mean        sd        2.5%        25%        50%
##     theta  0.5817572 0.1361712   0.3057664  0.4896599  0.5783317
##     lp__  -8.6648648 0.7032406 -10.7775608 -8.8603567 -8.3929534
##          stats
## parameter        75%      97.5%
##     theta  0.6849353  0.8333689
##     lp__  -8.2023793 -8.1515106</code></pre>
</div>
</div>
</div>
<div id="point-estimate-and-variability-2-levels" class="section level1">
<h1>point estimate and variability 2 levels</h1>
<p>stan_trace(samples) stan_hist(samples) stan_dens(samples) stan_scat(samples) stan_diag(samples) stan_rhat(samples) stan_ess(samples) stan_mcse(samples) stan_ac(samples)</p>
<p>as.array(samples)[1:15,,2] # array: sample, chain, parameter</p>
</div>

<p>Copyright &copy; 2017 OBrien Consulting - All rights reserved.</p>


</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
